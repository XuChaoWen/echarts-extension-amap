/*!
 * echarts-extension-amap 
 * @version 1.8.0
 * @author plainheart
 * 
 * MIT License
 * 
 * Copyright (c) 2019-2020 Zhongxiang.Wang
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).echarts=e.echarts||{},e.echarts.amap={}),e.echarts)}(this,(function(e,t){"use strict";function n(e,t){this._amap=e,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=t}var o=n.prototype,a=["echartsLayerZIndex","renderOnMoving","layers"];function i(e,n){return n=n||[0,0],t.util.map([0,1],(function(t){var o=n[t],a=e[t]/2,i=[],r=[];return i[t]=o-a,r[t]=o+a,i[1-t]=r[1-t]=n[1-t],Math.abs(this.dataToPoint(i)[t]-this.dataToPoint(r)[t])}),this)}o.dimensions=["lng","lat"],o.setZoom=function(e){this._zoom=e},o.setCenter=function(e){var t=new AMap.LngLat(e[0],e[1]);this._center=this._amap.lngLatToContainer(t)},o.setMapOffset=function(e){this._mapOffset=e},o.setAMap=function(e){this._amap=e},o.getAMap=function(){return this._amap},o.dataToPoint=function(e){var t=new AMap.LngLat(e[0],e[1]),n=this._amap.lngLatToContainer(t),o=this._mapOffset;return[n.x-o[0],n.y-o[1]]},o.pointToData=function(e){var t=this._mapOffset,n=this._amap.containerToLngLat(new AMap.Pixel(e[0]+t[0],e[1]+t[1]));return[n.lng,n.lat]},o.getViewRect=function(){var e=this._api;return new t.graphic.BoundingRect(0,0,e.getWidth(),e.getHeight())},o.getRoamTransform=function(){return t.matrix.create()},o.prepareCustoms=function(e){var n=this.getViewRect();return{coordSys:{type:"amap",x:n.x,y:n.y,width:n.width,height:n.height},api:{coord:t.util.bind(this.dataToPoint,this),size:t.util.bind(i,this)}}},n.dimensions=o.dimensions,n.create=function(e,o){var i,r=o.getDom();e.eachComponent("amap",(function(e){var s=o.getZr().painter,f=s.getViewportRoot();if("undefined"==typeof AMap)throw new Error("AMap api is not loaded");if(i)throw new Error("Only one amap component can exist");var p,u,c,d,m=e.getAMap();if(!m){var l=r.querySelector(".ec-extension-amap");l&&(f.style.left="0px",f.style.top="0px",r.removeChild(l)),(l=document.createElement("div")).className="ec-extension-amap",l.style.cssText="position:absolute;width:100%;height:100%",r.appendChild(l);var h=t.util.clone(e.get()),y=h.echartsLayerZIndex;t.util.each(a,(function(e){delete h[e]})),m=new AMap.Map(l,h),e.setAMap(m);var g=new AMap.CustomLayer(f,{zIndex:y});e.setEChartsLayer(g),m.add(g),p=".ec-amap-not-zoom",u="left:0!important;top:0!important",c=Infinity,d=AMap.version>=2?document.getElementById("AMap_Dynamic_style").sheet:document.getElementsByClassName("AMap.style")[0].sheet,c=c||0,d.insertRule?d.insertRule(p+"{"+u+"}",c):d.addRule&&d.addRule(p,u,c),s.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}var v=e.get("center"),_=e.get("zoom");if(v&&_){var M=m.getCenter(),w=m.getZoom();if(e.centerOrZoomChanged([M.lng,M.lat],w)){var O=new AMap.LngLat(v[0],v[1]);m.setZoomAndCenter(_,O)}}var b=e.__mapStyle,T=e.get("mapStyle");if(b!==T&&(m.setMapStyle(T),e.__mapStyle=T),m.setLang){var A=e.__mapLang,x=e.get("lang");A!==x&&(m.setLang(x),e.__mapLang=x)}(i=new n(m,o)).setMapOffset(e.__mapOffset||[0,0]),i.setZoom(_),i.setCenter(v),e.coordinateSystem=i})),e.eachSeries((function(e){"amap"===e.get("coordinateSystem")&&(e.coordinateSystem=i)}))},t.extendComponentModel({type:"amap",setAMap:function(e){this.__amap=e},getAMap:function(){return this.__amap},setEChartsLayer:function(e){this.__echartsLayer=e},getEChartsLayer:function(){return this.__echartsLayer},setCenterAndZoom:function(e,t){this.option.center=e,this.option.zoom=t},centerOrZoomChanged:function(e,t){var n,o,a=this.option;return n=e,o=a.center,!(n&&o&&n[0]===o[0]&&n[1]===o[1]&&t===a.zoom)},defaultOption:{center:[116.397428,39.90923],zoom:5,isHotspot:!1,resizeEnable:!0,echartsLayerZIndex:2e3,renderOnMoving:!0}});var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},s=/^\s+|\s+$/g,f=/^[-+]0x[0-9a-f]+$/i,p=/^0b[01]+$/i,u=/^0o[0-7]+$/i,c=parseInt,d="object"==typeof r&&r&&r.Object===Object&&r,m="object"==typeof self&&self&&self.Object===Object&&self,l=d||m||Function("return this")(),h=Object.prototype.toString,y=Math.max,g=Math.min,v=function(){return l.Date.now()};function _(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function M(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==h.call(e)}(e))return NaN;if(_(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=_(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(s,"");var n=p.test(e);return n||u.test(e)?c(e.slice(2),n?2:8):f.test(e)?NaN:+e}var w=function(e,t,n){var o,a,i,r,s,f,p=0,u=!1,c=!1,d=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){var n=o,i=a;return o=a=undefined,p=t,r=e.apply(i,n)}function l(e){return p=e,s=setTimeout(w,t),u?m(e):r}function h(e){var n=e-f;return f===undefined||n>=t||n<0||c&&e-p>=i}function w(){var e=v();if(h(e))return O(e);s=setTimeout(w,function(e){var n=t-(e-f);return c?g(n,i-(e-p)):n}(e))}function O(e){return s=undefined,d&&o?m(e):(o=a=undefined,r)}function b(){var e=v(),n=h(e);if(o=arguments,a=this,f=e,n){if(s===undefined)return l(f);if(c)return s=setTimeout(w,t),m(f)}return s===undefined&&(s=setTimeout(w,t)),r}return t=M(t)||0,_(n)&&(u=!!n.leading,i=(c="maxWait"in n)?y(M(n.maxWait)||0,t):i,d="trailing"in n?!!n.trailing:d),b.cancel=function(){s!==undefined&&clearTimeout(s),p=0,o=f=a=s=undefined},b.flush=function(){return s===undefined?r:O(v())},b};t.extendComponentView({type:"amap",render:function(e,n,o){var a=!0,i=e.getAMap(),r=o.getZr().painter.getViewportRoot(),s=i.getContainer(),f=r.parentNode,p=e.coordinateSystem,u=e.getEChartsLayer(),c=e.get("renderOnMoving"),d=e.get("resizeEnable"),m=AMap.version>=2,l="3D"===i.getViewMode_(),h=!m&&!l;f&&f.classList.add("ec-amap-not-zoom");var y,g=function(t){if(a)return;var n=[-parseInt(s.style.left,10)||0,-parseInt(s.style.top,10)||0];const i=r.style,f=n[0]+"px",u=n[1]+"px";i.left!==f&&(i.left=f),i.top!==u&&(i.top=u),p.setMapOffset(n),e.__mapOffset=n,o.dispatchAction({type:"amapRoam",animation:{duration:0}})},v=function(e){a||!m&&l||u.setOpacity(h?0:.01)},_=function(e){a||(h||u.setOpacity(1),o.dispatchAction({type:"amapRoam",animation:{duration:0}}),h&&(clearTimeout(this._layerOpacityTimeout),this._layerOpacityTimeout=setTimeout((function(){u.setOpacity(1)}),0)))};i.off("mapmove",this._oldMoveHandler),i.off("moveend",this._oldMoveHandler),i.off("viewchange",this._oldMoveHandler),i.off("camerachange",this._oldMoveHandler),i.off("zoomstart",this._oldZoomStartHandler),i.off("zoomend",this._oldZoomEndHandler),i.off("resize",this._oldResizeHandler),i.on(c?m?"viewchange":l?"camerachange":"mapmove":"moveend",h?g=w(g,0):g),i.on("zoomstart",v),i.on("zoomend",_=t.util.bind(_,this)),d&&(y=function(e){clearTimeout(this._resizeDelay),this._resizeDelay=setTimeout((function(){t.getInstanceByDom(o.getDom()).resize()}),100)},y=t.util.bind(y,this),i.on("resize",y)),this._oldMoveHandler=g,this._oldZoomStartHandler=v,this._oldZoomEndHandler=_,d&&(this._oldResizeHandler=y),a=!1},dispose:function(e,t){clearTimeout(this._layerOpacityTimeout),clearTimeout(this._resizeDelay);var n=e.getComponent("amap");n&&(n.getAMap().destroy(),n.setAMap(null),n.setEChartsLayer(null),n.coordinateSystem&&(n.coordinateSystem.setAMap(null),n.coordinateSystem=null))}}),t.registerCoordinateSystem("amap",n),t.registerAction({type:"amapRoam",event:"amapRoam",update:"updateLayout"},(function(e,t){t.eachComponent("amap",(function(e){var t=e.getAMap(),n=t.getCenter();e.setCenterAndZoom([n.lng,n.lat],t.getZoom())}))})),e.name="echarts-extension-amap",e.version="1.8.0",Object.defineProperty(e,"__esModule",{value:!0})}));
